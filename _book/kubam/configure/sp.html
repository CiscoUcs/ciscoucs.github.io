
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Configure Service Profiles Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../internals/" />
    
    
    <link rel="prev" href="deploy.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">UCS Developer Resources</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../API.html">
            
                <a href="../../API.html">
            
                    
                    UCS API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../PROGRAMMING.html">
            
                <a href="../../PROGRAMMING.html">
            
                    
                    Programming Languages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../CFGMGMT.html">
            
                <a href="../../CFGMGMT.html">
            
                    
                    Configuration Management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../OS/">
            
                <a href="../../OS/">
            
                    
                    Operating Systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.4.1" data-path="../../OS/COREOS.html">
            
                <a href="../../OS/COREOS.html">
            
                    
                    CoreOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4.2" data-path="../../OS/REDHAT.html">
            
                <a href="../../OS/REDHAT.html">
            
                    
                    RedHat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4.3" data-path="../../OS/UBUNTU.html">
            
                <a href="../../OS/UBUNTU.html">
            
                    
                    Ubuntu
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../../CONTAINERS/">
            
                <a href="../../CONTAINERS/">
            
                    
                    Containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../../SUPPORT.html">
            
                <a href="../../SUPPORT.html">
            
                    
                    Support
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">KUBAM</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../">
            
                <a href="../">
            
                    
                    KUBAM Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../RELEASE.html">
            
                <a href="../RELEASE.html">
            
                    
                    Release Notes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../installation/">
            
                <a href="../installation/">
            
                    
                    Install KUBAM
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="../installation/standard.html">
            
                <a href="../installation/standard.html">
            
                    
                    Standard CentOS/RedHat Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="../installation/ubuntu.html">
            
                <a href="../installation/ubuntu.html">
            
                    
                    Standard Ubuntu Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.3" data-path="../installation/network.html">
            
                <a href="../installation/network.html">
            
                    
                    Networking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.4" data-path="../installation/other.html">
            
                <a href="../installation/other.html">
            
                    
                    Other Tricky Installation Tips
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="./">
            
                <a href="./">
            
                    
                    Use KUBAM
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.4.1" data-path="creds.html">
            
                <a href="creds.html">
            
                    
                    Credentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.2" data-path="network.html">
            
                <a href="network.html">
            
                    
                    Networking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.3" data-path="servers.html">
            
                <a href="servers.html">
            
                    
                    Servers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.4" data-path="iso.html">
            
                <a href="iso.html">
            
                    
                    Boot Images
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.5" data-path="settings.html">
            
                <a href="settings.html">
            
                    
                    Settings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.6" data-path="template.html">
            
                <a href="template.html">
            
                    
                    Kickstart Templates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.7" data-path="windows2.html">
            
                <a href="windows2.html">
            
                    
                    Windows Windows AutoDeploy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.8" data-path="deploy.html">
            
                <a href="deploy.html">
            
                    
                    Deploy Install Images
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.4.9" data-path="sp.html">
            
                <a href="sp.html">
            
                    
                    Configure Service Profiles
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../internals/">
            
                <a href="../internals/">
            
                    
                    KUBAM Glorious Underbelly
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.5.1" data-path="../internals/stage1/docker.html">
            
                <a href="../internals/stage1/docker.html">
            
                    
                    Stage1 - Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5.2" data-path="../internals/stage1/esxi.html">
            
                <a href="../internals/stage1/esxi.html">
            
                    
                    Stage1 - ESXi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5.3" data-path="../internals/stage1/manual.html">
            
                <a href="../internals/stage1/manual.html">
            
                    
                    Stage1 - Manual
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5.4" data-path="../internals/stage2/python.html">
            
                <a href="../internals/stage2/python.html">
            
                    
                    Stage2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5.5" data-path="../internals/stage3/ansible.html">
            
                <a href="../internals/stage3/ansible.html">
            
                    
                    Stage3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5.6" data-path="../internals/stage4/manual.html">
            
                <a href="../internals/stage4/manual.html">
            
                    
                    Stage4
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../developer/">
            
                <a href="../developer/">
            
                    
                    KUBAM Developer
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.6.1" data-path="../developer/API.html">
            
                <a href="../developer/API.html">
            
                    
                    KUBAM API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6.2" data-path="../developer/APIGUIDE.html">
            
                <a href="../developer/APIGUIDE.html">
            
                    
                    KUBAM API Walkthrough
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6.3" data-path="../developer/YAML.html">
            
                <a href="../developer/YAML.html">
            
                    
                    KUBAM YAML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Configure Service Profiles</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="configure-service-profiles">Configure Service Profiles</h1>
<p>KUBAM first requires service profiles with <a href="https://community.cisco.com/t5/unified-computing-system/using-scriptable-vmedia-with-ucs-manager/ta-p/3638207" target="_blank">vmedia policies</a> be in place.  The idea is once you associate a physical server with a service profile it will immediately get all the bios settings, networking settings, install the operating system (os), and kubernetes in a single step.  To do this you first have to do the following: </p>
<ol>
<li>Have a service profile template</li>
<li>Have a service profile template that uses a vmedia policy. </li>
</ol>
<p>You can do this through the GUI, but that is not as cool.  Let&apos;s automate this.  </p>
<p>Before, in KUBAM version 1 we did all this for you.  The code is all in there somewhere but we found people had their own ways of doing things and wanted to do this part themselves.  As such, we have made an Ansible method available.  </p>
<p>And now for a rant on Ansible. In the first place, it is much faster to do the configuration of UCS with just straight python as we used to do in KUBAM.  However, Ansible is standard and has a bit more readability (if YAML is your thing).  However, Ansible is pretty slow, and still not my favorite.  Sorry if you a big fan and I just rained on your parade.  But for all its deficiencies it is still better than puppet and chef in terms of being declarative and not requiring dumb agents that just slow things down. End rant. </p>
<h2 id="ansible-for-ucs">Ansible For UCS</h2>
<p>You can start by downloading the <a href="https://github.com/CiscoUcs/ucsm-ansible" target="_blank">UCS ansible modules</a>.  Some of these modules are actually in the official <a href="https://docs.ansible.com/ansible/latest/modules/list_of_remote_management_modules.html#ucs" target="_blank">Ansible distribution</a>.  As an example of some ansible stuff already done, check out <a href="https://github.com/vallard/ucsm-ansible" target="_blank">my sample repo</a>.</p>
<p>In that example in the <code>site.yaml</code> file we create a service profile from the source template called <code>CentOS</code>.  Then after we create a service profile, we associate it with the server <code>blade-1</code>.  You can see the playbook <a href="https://github.com/vallard/ucsm-ansible/blob/master/site.yml" target="_blank">here</a>.</p>
<p>Notice that before we do that, we run a few roles to create the service profile template.  In the <a href="https://github.com/vallard/ucsm-ansible/blob/master/roles/server/tasks/main.yml" target="_blank">server role</a> we set up:</p>
<ul>
<li>BIOS policy with consistent device naming (CDN) this makes it so the interfaces show up as <code>eno1, eno2, ...</code>.  I highly recommend it. </li>
<li>UUID Pools</li>
<li>Configure the VMedia Policy for CentOS</li>
<li>Boot Policy</li>
<li>Set the boot order (HD first, then VMedia)</li>
<li>Scrub policy - Once you disassociate the blade we scrub the disk so our install works the next time we run this.  Otherwise, our schema won&apos;t work because a blade will boot up and already have an OS on it!</li>
<li>Maintenance Policy - Reboot right away!  This is dangerous in production!</li>
<li>Finally, we create the service profile template!</li>
</ul>
<h2 id="vmedia-for-redhat">VMedia For RedHat</h2>
<p>A VMedia Policy for RedHat requires two images:</p>
<ul>
<li>A CDD image that is common among all nodes</li>
<li>An HDD image that has the kickstart file that is unique to each node. </li>
</ul>
<p>The way we make it unique to each node is to use the service profile name.  So if our service profile is named <code>node01</code> then for the HDD image, it will look for <code>node01.img</code> file. Below is the ansible playbook to generate this vmedia policy file.  You can then add it to the service profile template.  </p>
<p>You will need to use the KUBAM server as the <code>remote_ip_address</code> as that is where both of these files will be created and live.</p>
<pre><code>- name: Configure Vmedia Policy
  ucs_managed_objects:
    &lt;&lt;: *login_info
    objects:
    - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaMountConfigPolicy
      class: CimcvmediaMountConfigPolicy
      properties: 
        name: kubam-centos7.5
        retry_on_mount_fail: &quot;yes&quot;
        parent_mo_or_dn: org-root/org-Ansible
        descr: &quot;KUBAM policy&quot;
      children:
      - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaConfigMountEntry
        class: CimcvmediaConfigMountEntry
        properties:
          mapping_name: centos7.5
          device_type: cdd
          mount_protocol: http
          remote_ip_address: 10.93.140.118
          image_name_variable: none
          image_file_name: centos7.5-boot.iso
          image_path: kubam
      - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaConfigMountEntry
        class: CimcvmediaConfigMountEntry
        properties:
          mapping_name: ks
          device_type: hdd
          mount_protocol: http
          remote_ip_address: 10.93.140.118
          image_name_variable: service-profile-name
image_path: kubam
</code></pre><h2 id="vmedia-for-vmware">VMedia for VMware</h2>
<p>For VMware, the vmedia is just a single ISO image for each node that is unique.  This has to do with the installation properties.  For VMware, we can&apos;t mount the kickstart file from a seperate disk like we can with RedHat. </p>
<pre><code>- name: Configure ESXi Policy
  ucs_managed_objects:
    &lt;&lt;: *login_info
    objects:
    - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaMountConfigPolicy
      class: CimcvmediaMountConfigPolicy
      properties:
        name: kubam-esxi
        retry_on_mount_fail: &quot;yes&quot;
        parent_mo_or_dn: org-root/org-Ansible
        descr: &quot;KUBAM ESXi policy&quot;
      children:
      - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaConfigMountEntry
        class: CimcvmediaConfigMountEntry
        properties:
          mapping_name: esxi
          device_type: cdd
          mount_protocol: http
          remote_ip_address: 10.93.140.118
          image_name_variable: service-profile-name
          image_path: kubam
</code></pre><h2 id="vmedia-for-ubuntu">VMedia For Ubuntu</h2>
<p>For Ubuntu, we are similar to ESXi but the difference is our media we create is much smaller!  Only 50MB compared to the giant ones that VMware and RH create.  This means faster installations, yay!</p>
<p>Basically, you need to map the service profile template name to the ansible playbook. </p>
<pre><code>- name: Configure Ubuntu Policy
  ucs_managed_objects:
    &lt;&lt;: *login_info
    objects:
    - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaMountConfigPolicy
      class: CimcvmediaMountConfigPolicy
      properties:
        name: kubam-ubuntu
        retry_on_mount_fail: &quot;yes&quot;
        parent_mo_or_dn: org-root/org-Ansible
        descr: &quot;KUBAM Ubuntu policy&quot;
      children:
      - module: ucsmsdk.mometa.cimcvmedia.CimcvmediaConfigMountEntry
        class: CimcvmediaConfigMountEntry
        properties:
          mapping_name: ubuntu
          device_type: cdd
          mount_protocol: http
          remote_ip_address: 10.93.140.118
          image_name_variable: service-profile-name
          image_path: kubam
</code></pre><h2 id="the-cart-before-the-horse">The cart before the horse</h2>
<p>Now if you haven&apos;t generated all these images yet then this obviously won&apos;t work.  Hopefully you have generated all these assets in KUBAM first before doing the node automation part. Then it should come right up!</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="deploy.html" class="navigation navigation-prev " aria-label="Previous page: Deploy Install Images">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../internals/" class="navigation navigation-next " aria-label="Next page: KUBAM Glorious Underbelly">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Configure Service Profiles","level":"3.4.9","depth":2,"next":{"title":"KUBAM Glorious Underbelly","level":"3.5","depth":1,"path":"kubam/internals/README.md","ref":"kubam/internals/README.md","articles":[{"title":"Stage1 - Docker","level":"3.5.1","depth":2,"path":"kubam/internals/stage1/docker.md","ref":"kubam/internals/stage1/docker.md","articles":[]},{"title":"Stage1 - ESXi","level":"3.5.2","depth":2,"path":"kubam/internals/stage1/esxi.md","ref":"kubam/internals/stage1/esxi.md","articles":[]},{"title":"Stage1 - Manual","level":"3.5.3","depth":2,"path":"kubam/internals/stage1/manual.md","ref":"kubam/internals/stage1/manual.md","articles":[]},{"title":"Stage2","level":"3.5.4","depth":2,"path":"kubam/internals/stage2/python.md","ref":"kubam/internals/stage2/python.md","articles":[]},{"title":"Stage3","level":"3.5.5","depth":2,"path":"kubam/internals/stage3/ansible.md","ref":"kubam/internals/stage3/ansible.md","articles":[]},{"title":"Stage4","level":"3.5.6","depth":2,"path":"kubam/internals/stage4/manual.md","ref":"kubam/internals/stage4/manual.md","articles":[]}]},"previous":{"title":"Deploy Install Images","level":"3.4.8","depth":2,"path":"kubam/configure/deploy.md","ref":"kubam/configure/deploy.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"kubam/configure/sp.md","mtime":"2019-02-15T18:24:25.054Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-02-15T23:22:09.636Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

